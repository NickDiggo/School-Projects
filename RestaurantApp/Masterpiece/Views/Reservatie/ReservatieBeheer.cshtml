@model List<ReservatieBeheerViewModel>

<h2>Reservaties beheren</h2>

<!-- FILTER -->
<div class="mb-3 d-flex flex-wrap gap-3 align-items-end">
    <div>
        <label class="form-label fw-bold">Filter</label>
        <select id="filter" class="form-select" style="max-width: 280px;">
            <option value="alle">Alle</option>
            <option value="toekomst">Toekomstige reservaties</option>
            <option value="verleden">Afgelopen reservaties</option>
            <option value="noshow">Niet opgedaagd</option>
        </select>
    </div>

    <div>
        <label class="form-label fw-bold">Filter op naam</label>
        <input type="text" id="filterNaam" class="form-control" style="max-width: 280px;" placeholder="Typ naam...">
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Naam</th>
                <th>Datum</th>
                <th>Aantal personen</th>
                <th>Tijdslot</th>
                <th>Status</th>
                <th class="text-center">Acties</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in Model)
            {
                var isVerleden = r.Datum.Date < DateTime.Today;
                var isNoShow = isVerleden && !r.IsAanwezig;

                <tr data-verleden="@isVerleden.ToString().ToLower()"
                    data-noshow="@isNoShow.ToString().ToLower()"
                    class="@(isNoShow ? "table-danger" : "")">
                    <td>@r.KlantNaam</td>
                    <td>@r.Datum.ToString("yyyy-MM-dd")</td>
                    <td>@r.AantalPersonen</td>
                    <td>@r.TijdslotNaam</td>
                    <td>@(r.IsAanwezig ? "Aanwezig" : "Niet aanwezig")</td>

                    <!-- Acties: Edit + Delete inline -->
                    <td class="text-center">
                        @if (!r.IsAanwezig)
                        {
                            <button class="btn btn-sm text-warning me-1 btn-update"
                                    data-id="@r.Id"
                                    data-aantal="@r.AantalPersonen"
                                    data-datum="@r.Datum.ToString("yyyy-MM-dd")"
                                    data-tijdslotid="@r.TijdslotId"
                                    data-tijdslot="@r.TijdslotNaam">
                                <i class="bi bi-pen fs-5"></i>
                            </button>
                            <button class="btn btn-sm text-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteModal"
                                    data-id="@r.Id">
                                <i class="bi bi-trash fs-5"></i>
                            </button>
                        }
                        else
                        {
                            <!-- Houd layout consistent -->
                            <span class="btn btn-sm invisible me-1"><i class="bi bi-pen fs-5"></i></span>
                            <span class="btn btn-sm invisible"><i class="bi bi-trash fs-5"></i></span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>



<!-- CONFIRMATION DELETE MODAL -->
@if (TempData["ReservatieVerwijderd"] != null)
{
    <div class="modal fade" id="deletedConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 text-center">
                <h5 class="text-success mb-3">
                    Reservatie succesvol verwijderd
                </h5>
                <p>De reservatie is correct verwijderd.</p>
                <button type="button" class="btn btn-success mt-2" data-bs-dismiss="modal">
                    Ok
                </button>
            </div>
        </div>
    </div>
}


<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3 text-center">
            <h5>Weet je zeker dat je deze reservatie wilt verwijderen?</h5>
            <form asp-action="Verwijder" method="post">
                <input type="hidden" id="deleteId" name="id" value="" />
                <button type="submit" class="btn btn-danger mt-2">Ja, verwijderen</button>
                <button type="button" class="btn btn-secondary mt-2" data-bs-dismiss="modal">Annuleer</button>
            </form>
        </div>
    </div>
</div>

<!-- UPDATE FLOW MODALS -->
<!-- 1️⃣ AANTAL PERSONEN -->
<div class="modal fade" id="updateAantalModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
            <h5>Update aantal personen</h5>
            <input type="number" id="updateAantalInput" class="form-control" min="1" max="24" />
            <span id="updateAantalError" class="text-danger"></span>
            <button type="button" class="btn btn-success mt-3" id="btnUpdateAantalVolgende">
                Volgende: Kies datum
            </button>
        </div>
    </div>
</div>

<!-- 2️⃣ DATUM -->
<div class="modal fade" id="updateDatumModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
            <h5>Update datum</h5>
            <input type="text" id="updateDatumPicker" class="form-control" />
            <button type="button" class="btn btn-success mt-3" id="btnUpdateDatumVolgende">
                Volgende: Kies tijdslot
            </button>
        </div>
    </div>
</div>

<!-- 3️⃣ TIJDSLOT -->
<div class="modal fade" id="updateTijdslotModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
            <h5>Update tijdslot</h5>
            <div id="updateTijdslotContainer"></div>
            <button type="button" class="btn btn-success mt-3" id="btnUpdateTijdslotVolgende" disabled>
                Volgende: Samenvatting
            </button>
        </div>
    </div>
</div>

<!-- 4️⃣ SAMENVATTING -->
<div class="modal fade" id="updateSamenvattingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
            <h5>Samenvatting update</h5>
            <p>Aantal personen: <span id="samenvattingAantal"></span></p>
            <p>Datum: <span id="samenvattingDatum"></span></p>
            <p>Tijdslot: <span id="samenvattingTijdslot"></span></p>

            <form asp-action="Update" method="post" id="updateForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="formUpdateId" />
                <input type="hidden" name="AantalPersonen" id="formUpdateAantal" />
                <input type="hidden" name="Datum" id="formUpdateDatum" />
                <input type="hidden" name="TijdslotId" id="formUpdateTijdslotId" />
                <button type="submit" class="btn btn-success">Bevestig update</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // -------------------------------
            // FILTER LOGICA
            // -------------------------------
            const filter = document.getElementById("filter");
            const filterNaam = document.getElementById("filterNaam");
            const rows = document.querySelectorAll("tbody tr");

            function applyFilters() {
                const val = filter.value.toLowerCase();
                const naamVal = filterNaam.value.toLowerCase();

                rows.forEach(row => {
                    const isVerleden = row.dataset.verleden === "true";
                    const isNoShow = row.dataset.noshow === "true";
                    const naam = row.querySelector("td").textContent.toLowerCase();

                    let show = true;
                    switch (val) {
                        case "toekomst": show = !isVerleden; break;
                        case "verleden": show = isVerleden; break;
                        case "noshow": show = isNoShow; break;
                    }

                    if (naamVal && !naam.includes(naamVal)) show = false;
                    row.style.display = show ? "" : "none";
                });
            }

            filter.addEventListener("change", applyFilters);
            filterNaam.addEventListener("input", applyFilters);

            // -------------------------------
            // DELETE MODAL
            // -------------------------------
            const deleteModal = document.getElementById('deleteModal');
            deleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                document.getElementById('deleteId').value = button.getAttribute('data-id');
            });

            // -------------------------------
            // UPDATE FLOW
            // -------------------------------
            let updateReservatieId, updateAantal, updateDatum, updateTijdslot;
            const updateAantalModal = new bootstrap.Modal(document.getElementById('updateAantalModal'));
            const updateDatumModal = new bootstrap.Modal(document.getElementById('updateDatumModal'));
            const updateTijdslotModal = new bootstrap.Modal(document.getElementById('updateTijdslotModal'));
            const updateSamenvattingModal = new bootstrap.Modal(document.getElementById('updateSamenvattingModal'));

            // Klik op EDIT
            document.querySelectorAll('.btn-update').forEach(btn => {
                btn.addEventListener('click', function () {
                    updateReservatieId = this.dataset.id;
                    updateAantal = this.dataset.aantal;
                    updateDatum = this.dataset.datum;
                    updateTijdslot = this.dataset.tijdslotid;

                    document.getElementById('updateAantalInput').value = updateAantal;
                    document.getElementById('updateAantalError').textContent = "";

                    updateAantalModal.show();
                });
            });

            // STEP 1 → datum
            document.getElementById('btnUpdateAantalVolgende').addEventListener('click', async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Beschikbare datums ophalen...`;

                updateAantal = document.getElementById('updateAantalInput').value;

                const response = await fetch(`/Reservatie/GetBeschikbareData?aantalPersonen=${updateAantal}`);
                const beschikbareDatums = await response.json();

                if (!beschikbareDatums || beschikbareDatums.length === 0) {
                    document.getElementById('updateAantalError').textContent = "Geen beschikbare datums.";
                    btn.disabled = false;
                    btn.innerHTML = "Volgende: Kies datum";
                    return;
                }

                const datumInput = document.getElementById("updateDatumPicker");
                if (datumInput._flatpickr) datumInput._flatpickr.destroy();

                flatpickr("#updateDatumPicker", {
                    dateFormat: "Y-m-d",
                    defaultDate: updateDatum,
                    enable: beschikbareDatums,
                    onChange: function (selectedDates, dateStr) {
                        updateDatum = dateStr;
                    }
                });

                updateAantalModal.hide();
                updateDatumModal.show();
                btn.disabled = false;
                btn.innerHTML = "Volgende: Kies datum";
            });

            // STEP 2 → tijdslot
            document.getElementById('btnUpdateDatumVolgende').addEventListener('click', function () {
                updateDatumModal.hide();

                fetch(`/Reservatie/GetTijdsloten?datum=${updateDatum}&aantalPersonen=${updateAantal}`)
                    .then(res => res.json())
                    .then(data => {
                        const container = document.getElementById('updateTijdslotContainer');
                        container.innerHTML = '';

                        data.forEach(ts => {
                            const div = document.createElement('div');
                            div.className = 'form-check mb-2';

                            const input = document.createElement('input');
                            input.type = 'radio';
                            input.name = 'updateTijdslot';
                            input.value = ts.tijdslotId;
                            input.id = `ts${ts.tijdslotId}`;
                            input.className = 'form-check-input';
                            input.disabled = !ts.isBeschikbaar;
                            if (ts.tijdslotId == updateTijdslot) input.checked = true;

                            const label = document.createElement('label');
                            label.setAttribute('for', input.id);
                            label.className = 'form-check-label';
                            label.textContent = `${ts.naam} (${ts.beschikbarePlaatsen} plaatsen beschikbaar)`;

                            div.appendChild(input);
                            div.appendChild(label);
                            container.appendChild(div);
                        });

                        document.getElementById('btnUpdateTijdslotVolgende').disabled =
                            !document.querySelector('input[name="updateTijdslot"]:checked');

                        container.addEventListener('change', () => {
                            document.getElementById('btnUpdateTijdslotVolgende').disabled = false;
                        });

                        updateTijdslotModal.show();
                    });
            });

            // STEP 3 → samenvatting
            document.getElementById('btnUpdateTijdslotVolgende').addEventListener('click', function () {
                const gekozenTijdslot = document.querySelector('input[name="updateTijdslot"]:checked');
                if (!gekozenTijdslot) return;

                updateTijdslot = gekozenTijdslot.value;

                document.getElementById('samenvattingAantal').innerText = updateAantal;
                document.getElementById('samenvattingDatum').innerText = updateDatum;
                document.getElementById('samenvattingTijdslot').innerText = gekozenTijdslot.nextSibling.textContent.trim();

                document.getElementById('formUpdateId').value = updateReservatieId;
                document.getElementById('formUpdateAantal').value = updateAantal;
                document.getElementById('formUpdateDatum').value = updateDatum;
                document.getElementById('formUpdateTijdslotId').value = updateTijdslot;

                updateTijdslotModal.hide();
                updateSamenvattingModal.show();
            });
                    @if (TempData["ReservatieVerwijderd"] != null)
        {
                
    }


        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modal = new bootstrap.Modal(
                document.getElementById("deletedConfirmModal")
            );
            modal.show();
        });
    </script>
}
